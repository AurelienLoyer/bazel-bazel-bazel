:revealjsdir: https://cdn.rawgit.com/hakimel/reveal.js/3.8.0/
:revnumber: {project-version}
:example-caption!:
ifndef::imagesdir[:imagesdir: images]
:docinfo: shared
:navigation:
:menu:
:header_footer: true
:status:
:slideNumber: true
:showSlideNumber: true
:title-slide-transition: zoom
:title-slide-transition-speed: fast
:icons: font
:revealjs_history: true

[.black.background]
== !

[.notes]
--
Nous sommes √† une epoque ou la taille de nos projet est de plus en grande, le nombre de dependances grossit de jour en jour, ou encore la duree d'un build et de nots tests sont trop long pour avoir un feedback rapidement. parler de lInner source . ous ne sommes pas les seuls a avoir ce probl√®me. En effet, des grosses soci√©tes se sont pench√©s sur le sujet, et notamment Google qui propose ... 
--

== !

image::bazel.png[]

[.notes]
--
l'outil open-source Bazel que nous allons vous pr√©senter aujourd'hui
--

[.speaker]
=== !

[id="speaker-bio"]
--
Emmanuel DEMEY

Developer Advocate √† Zenika Lille 

@EmmanuelDemey
--

image::emmanuel.jpg[]

[.speaker]
=== !

[id="speaker-bio"]
--
Aur√©lien LOYER

Consultant √† Zenika Lille 

@AurelienDemey
--

image::aurelien.jpeg[]

[.companies]
== !

image::google.png[]
image::elastic.png[]
image::wix.png[]
image::etsy.png[]
image::dropbox.png[]
image::stripe.png[]

[.notes]
--
TODO : Trouver d'autres societes
--

== !

image::google_codebase.png[]

[.notes]
--
Bazel est donc un outil de build cr√©√© par Google, au d√©but pour un usage interne. En effet, il est utilis√©, sous un nom different Blaze, depuis plusieurs ann√©e sur leur monorepo contenant presque la totalit√© des projets d√©v√©lopp√©s par Google voir m√™me les d√©pendances et les outils utilise√©. 
Bien evidemment, Google √† mis en place de nombreux outils pour faciliter et rendre possible l'utilisation d'un mono repo pour les developpeurs
--


== üõ† chez Google

[.column]
* Piper
* CiTC
* Critique
* Codesearch

[.column]
* Tricorder
* Presubmit
* TAP
* Rosie

[.notes]
--
Nous avons par exemple ces outils qui on en charge de faciliter l'utilisation du mono repo chez Google
--

== !

NOTE: Build and test software of any size, quickly and reliably.

[.notes]
--
Et donc l'une des brique primordial est Bazel. Afin de partir sur des bonnes bases, nous allons d√©finir tout d'abord 
Parler du remote execution

--

== !

image::angular.png[]

[.notes]
--
Parler que nous aurions pu faire juste une demo d'angular avec bazel, mais cela n'aurait pas permis de comprendre la syntaxe. 
Mais faire tout de mmeme une demo d'angular cli avec le support Bazel pour montrer le support et le fait que cela ne change rien pour l'utilisateur

ng new . ...
git add . git commit
ng add @angular/bazel
git diff
executer deux fois pour voir le temps d'execution
--

== !

++++
<iframe src="https://giphy.com/embed/UrEQirmnMPxBwToULv" width="960" height="540" frameBorder="0" class="giphy-embed" allowFullScreen></iframe>
++++

[.notes]
--
Demo
--

== !

NOTE: Il faut voir Bazel comme un orchestrateur, et non comme un nouvel outil de build √† apprendre

[.notes]
--
--

[.list-without-style.hidden-title.two-em]
== Terminologie

[%step]
* Workspace
* Package
* Target
* Rule
* Label
* Extension

[.notes]
--
--

== Getting Started

++++
<iframe src="https://giphy.com/embed/1BFGiiHYS2dAbC0Lx1" width="480" height="480" frameBorder="0" class="giphy-embed" allowFullScreen></iframe>
++++

[.notes]
--
TODO: 
- Screenshot d'un arbo bazel avec un WORKSPACE et des fichiers BUILD
- Parler de la granularit√© a utiliser. comme mave ? ou une granulatie plus petite. on gagne en performance, mais on perd en maintenabilite
--

[.hidden-title]
== Getting Started

image::structure.png[structure,600,600]


== Starlark

[source,python]
----
def fizz_buzz(n):
  """Print Fizz Buzz numbers from 1 to n."""
  for i in range(1, n + 1):
    s = ""
    if i % 3 == 0:
      s += "Fizz"
    if i % 5 == 0:
      s += "Buzz"
    print(s if s else i)

fizz_buzz(20)
----

[.notes]
--
--

== Diff√©rence avec Python

[%step]
* Les variables globales sont immutables
* Les `for` et `if` utilisables que dans des fonctions
* Recursion impossible
* Modifier une collection pendant une it√©ration
* Les `class` et `import` non support√©s (`struct` et `load`).
* Les `string` sont entre double quotes
* ...


[.notes]
--
TODO: 
- Mettre le contenu d'un fichier bzl. Pour montrer que c'est tres complique et que nous allons preferer utiliser des rules predefinies
--

== üá´üá∑ Multi Langage

[.column]
* Android
* C / C++
* C#
* Docker
* Go
* Groovy

[.column]
* Kotlin
* iOS
* Java
* Javascript
* Perl
* Rust

[.column]
* Python
* Ruby
* Rust
* Sass
* Typescript
* ...

[.notes]
--
TODO: Mettre la liste des language supportes
TODO : Parler d'extensibilite
--

== Fonctions pures

[source,javascript]
----
function sum( a:number, b: number): number {
    return a + b;
}
const result = sum(1 + 2);
----

[.notes]
--
--

=== Fonctions pures

[source,javascript]
----
function sum( a:number, b: number): number {
    return a + b;
}

function mult( a:number, factor: number): number {
    return a * factor;
}

const result = mult( sum(1, 2), 3);
----

[.notes]
--
--

=== Fonctions pures

image::deps.svg[]

[.notes]
--
- DEMO Presenter le graph du projet angular
bazel query "deps(//packages/http)" --output graph | dot -Tpng > /tmp/dep.png
open /tmp/dep.png 
--

== Les labels

Un label correspond √† 

* un fichier 
* une target

=== Les labels

* //foo/bar:wiz	
* //foo/bar
* //foo/bar:all
* //foo/...

[.notes]
--
--

=== Les labels

Si je suis dans le r√©pertoire `foo`

* :foo == //foo:foo.
* bar:wiz == //foo/bar:wiz.
* bar/wiz == //foo/bar/wiz:wiz.

[.notes]
--
--

== Cr√©er une target

[source,python]
----
genrule(
    name = "copy-file",
    srcs = [
        "//some:file",
    ],
    outs = ["concatenated.txt"],
    cmd = "cp $< $@",
)
----

[.notes]
--
TODO: 
- appeler gen_rule
--


== D√©pendances

[source,python]
----
genrule(
    name = "copy-file",
    srcs = [ "//some:file" ],
    outs = ["concatenated.txt"],
    cmd = "cp $< $@",
)

genrule(
    name = "copy-file",
    srcs = [
        "copy-file", "//some:file2",
    ],
    outs = ["final.txt"],
    cmd = "cat $(locations //copy-file) $(location //some:file2) > $@",
)
----

[.notes]
--
TODO: 
- appeler gen_rule apres une autre genrule pour montrer la dependances
--

== Macro

[source,python]
----
def my_macro(name, **kwargs):
    genrule(
        name = "%s_first" % name,
        srcs = [ "//some:file" ],
        outs = ["concatenated.txt"],
        cmd = "cp $< $@",
    )

    genrule(
        name = name,
        **kwargs
    )
----

== Macro

[source,python]
----
my_macro(
    name = "copy-file",
    srcs = [
        "copy-file", "//some:file2",
    ],
    outs = ["final.txt"],
    cmd = "cat $(locations //copy-file) $(location //some:file2) > $@",
)
----

== Custom rules

[source,python]
----
def ts_binary_impl(ctx):
  files = list(get_transitive_files(ctx))
  output = ctx.outputs.out
  flags = ' '.join(ctx.attr.flags)
  ctx.action(
      inputs=files,
      outputs=[output],
      command="tsc %s --out %s %s" % (
          flags, output.path, ' '.join([f.path for f in files])))

ts_binary = rule(
  implementation = ts_binary_impl,
  attrs = {
      "srcs": attr.label_list(allow_files=ts_filetype),
      "deps": attr.label_list(allow_files=False),
      "flags": attr.string_list(),
  },
  outputs = {"out": "%{name}.js"},
)]
----

[.notes]
--
TODO: 
- Mettre le code de la regle BZL ici 
- Montrer comment charger le fichier 
- Montrer le parametrage d'une regle custom 
--

== !

++++
<iframe src="https://giphy.com/embed/uhb1F8ebDgkzC" width="960" height="540" frameBorder="0" class="giphy-embed" allowFullScreen></iframe>
++++

[.notes]
--
TODO:
- /Users/emmanueldemey/Documents/workspaces/oss/rules_nodejs/packages/labs/src/protobufjs/ts_proto_library.bzls
- Parler que nous pouvons d√©finir des variabls priv√©es
- Parler de l'outillage
    - Parler du beautifuer
    - Parler des extensions VSCode
revenir sur le code angulkar pour expliquer les fichiers build genere
https://dev.to/jakeherringbone/layering-in-bazel-for-web-389h
--

[.hidden-title]
== Conclusion

image::release.png[release,600,600]

[.notes]
--
TODO: 
- Ajouter un diff GIT pour montrer les fichiers ajout√©s
- Support dans Angular CLI 
- Builder en remote avec plus core 
Ce n'est pas pour tout le monde
Pour un startup ou un nouveau projet, ne pas choisir bazel
Choisir une solution historique. si le projet grossit, eventuellement .

Ecosysteme plus large
Syntaxe a simplifier 
Documentation
Creer de l'outillage pour faciliter la migraton. Un plugin existe deja pour migrer maven, et gazelle pour le monde nodejs
--
